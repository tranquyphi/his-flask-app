<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Visits - HIS</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="/static/css/fontawesome.all.min.css" />
    <script src="/static/js/jquery-3.6.0.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.bootstrap5.min.js"></script>
    <style>
        .patient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .stat-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .visit-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .visit-card:hover {
            border-left-color: #28a745;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .diagnosis-badge {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 5px 12px;
            margin: 2px;
            display: inline-block;
            font-size: 0.875rem;
        }
        .timeline {
            position: relative;
            padding: 0;
            list-style: none;
        }
        .timeline:before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50px;
            width: 2px;
            background-color: #e9ecef;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 80px;
        }
        .timeline-icon {
            position: absolute;
            left: 38px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .btn-action {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .visit-purpose-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }
        .staff-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 5px 0;
            margin-bottom: 5px;
        }
        .staff-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .staff-info {
            color: #6c757d;
            font-size: 0.8rem;
        }
        .staff-badge {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 15px;
            padding: 3px 10px;
            margin: 2px 0;
            display: inline-block;
            font-size: 0.8rem;
            color: #0066cc;
        }
        .department-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            border-radius: 15px;
            padding: 3px 10px;
            font-size: 0.8rem;
        }
        .staff-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .dataTables_wrapper .dataTables_filter { display: none; }
    </style>
</head>
<body class="p-3">
    <div class="container-fluid">
        <!-- Patient Header -->
        <div class="patient-header" id="patientHeader">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle me-3" style="font-size: 3rem;"></i>
                        <div>
                            <h2 class="mb-1" id="patientName">Loading...</h2>
                            <div class="row">
                                <div class="col-auto">
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="fas fa-id-card me-1"></i>
                                        <span id="patientId">-</span>
                                    </span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="fas fa-venus-mars me-1"></i>
                                        <span id="patientGender">-</span>
                                    </span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="fas fa-birthday-cake me-1"></i>
                                        <span id="patientAge">-</span> tuổi
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" id="backBtn" onclick="history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="statsCards">
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="totalVisits">-</h4>
                                <p class="card-text">Tổng lượt khám</p>
                            </div>
                            <i class="fas fa-calendar-check stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="uniqueDepartments">-</h4>
                                <p class="card-text">Khoa điều trị</p>
                            </div>
                            <i class="fas fa-hospital stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="firstVisitDate">-</h4>
                                <p class="card-text">Lần khám đầu</p>
                            </div>
                            <i class="fas fa-clock stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="latestVisitDate">-</h4>
                                <p class="card-text">Lần khám gần nhất</p>
                            </div>
                            <i class="fas fa-history stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="visitTabs">
            <li class="nav-item">
                <a class="nav-link active" id="timeline-tab" data-bs-toggle="tab" href="#timeline">
                    <i class="fas fa-timeline me-2"></i>Timeline
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="table-tab" data-bs-toggle="tab" href="#table">
                    <i class="fas fa-table me-2"></i>Danh sách chi tiết
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="stats-tab" data-bs-toggle="tab" href="#stats">
                    <i class="fas fa-chart-pie me-2"></i>Thống kê
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Timeline Tab -->
            <div class="tab-pane fade show active" id="timeline">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-timeline me-2"></i>Timeline khám bệnh
                                    </h5>
                                    <button class="btn btn-primary btn-sm" id="addVisitBtn">
                                        <i class="fas fa-plus me-1"></i>Thêm lượt khám
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="timelineContainer">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Tab -->
            <div class="tab-pane fade" id="table">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>Danh sách lượt khám
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchVisits" placeholder="Tìm kiếm...">
                                    <button class="btn btn-outline-secondary" id="refreshBtn">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="visitsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>STT</th>
                                        <th>Ngày khám</th>
                                        <th>Bác sĩ</th>
                                        <th>Mục đích</th>
                                        <th>Chẩn đoán</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div class="tab-pane fade" id="stats">
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-diagnoses me-2"></i>Chẩn đoán thường gặp
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="commonDiagnoses">
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Visit Modal -->
    <div class="modal fade" id="addVisitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Thêm lượt khám mới
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addVisitForm">
                    <div class="modal-body">

                        <div class="mb-3">
                            <label for="visitStaff" class="form-label">Bác sĩ *</label>
                            <select class="form-select" id="visitStaff" multiple required>
                                <option value="">Chọn bác sĩ...</option>
                            </select>
                            <small class="form-text text-muted">Có thể chọn nhiều bác sĩ bằng cách giữ Ctrl (hoặc Cmd trên Mac)</small>
                            <div class="invalid-feedback">Vui lòng chọn ít nhất một bác sĩ</div>
                        </div>
                        <div class="mb-3">
                            <label for="visitPurpose" class="form-label">Mục đích khám *</label>
                            <select class="form-select" id="visitPurpose" required>
                                <option value="">Chọn mục đích...</option>
                                <option value="Thường quy">Thường quy</option>
                                <option value="Cấp cứu">Cấp cứu</option>
                                <option value="Phòng khám">Phòng khám</option>
                                <option value="Nhận bệnh">Nhận bệnh</option>
                                <option value="Tái khám">Tái khám</option>
                                <option value="Khám chuyên khoa">Khám chuyên khoa</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="visitDiagnosis" class="form-label">Chẩn đoán</label>
                            <textarea class="form-control" id="visitDiagnosis" rows="3" placeholder="Nhập chẩn đoán (nếu có)"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="visitICDCode" class="form-label">Mã ICD</label>
                            <input type="text" class="form-control" id="visitICDCode" placeholder="Mã ICD (nếu có)">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Lưu lượt khám
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentPatientId = null;
        let visitsData = [];
        let summaryData = null;
        let visitsTable = null;

        $(document).ready(function() {
            // Get patient ID from URL or default
            const urlPath = window.location.pathname;
            const pathSegments = urlPath.split('/');
            currentPatientId = pathSegments[pathSegments.length - 1] || '2500073657';
            
            // Initialize
            initializePage();
            loadPatientVisits();
            loadSummaryData();
            setupEventHandlers();
        });

        function initializePage() {
            // Initialize DataTable
            visitsTable = $('#visitsTable').DataTable({
                responsive: true,
                processing: true,
                serverSide: false,
                data: [],
                columns: [
                    { 
                        data: null,
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { 
                        data: 'VisitTime',
                        render: function(data) {
                            if (!data) return '<span class="text-muted">Chưa có</span>';
                            return new Date(data).toLocaleDateString('vi-VN');
                        }
                    },
                    { 
                        data: 'staff',
                        render: function(data) {
                            if (!data || data.length === 0) {
                                return '<span class="text-muted">Chưa có bác sĩ</span>';
                            }
                            let html = '';
                            data.forEach(staff => {
                                html += `<div class="staff-item">
                                    <strong>${staff.StaffName || 'N/A'}</strong><br>
                                    <small class="staff-info">${staff.StaffRole || ''}</small>
                                </div>`;
                            });
                            return html;
                        }
                    },
                    { 
                        data: 'VisitPurpose',
                        render: function(data) {
                            const colors = {
                                'Thường quy': 'primary',
                                'Cấp cứu': 'danger', 
                                'Phòng khám': 'info',
                                'Tái khám': 'success'
                            };
                            const color = colors[data] || 'secondary';
                            return `<span class="badge bg-${color} visit-purpose-badge">${data || 'N/A'}</span>`;
                        }
                    },
                    { 
                        data: 'diagnoses',
                        render: function(data) {
                            if (!data || data.length === 0) {
                                return '<span class="text-muted">Chưa có chẩn đoán</span>';
                            }
                            let html = '';
                            data.forEach(diag => {
                                if (diag.ActualDiagnosis) {
                                    html += `<span class="diagnosis-badge">${diag.ActualDiagnosis}</span>`;
                                }
                            });
                            return html || '<span class="text-muted">Chưa có chẩn đoán</span>';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <button class="btn btn-sm btn-outline-primary btn-action view-btn" data-id="${row.VisitId}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning btn-action edit-btn" data-id="${row.VisitId}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-action delete-btn" data-id="${row.VisitId}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    emptyTable: "Chưa có lượt khám nào"
                },
                order: [[1, 'desc']]
            });
        }

        function setupEventHandlers() {
            // Search functionality
            $('#searchVisits').on('keyup', function() {
                visitsTable.search(this.value).draw();
            });

            // Refresh button
            $('#refreshBtn').on('click', function() {
                loadPatientVisits();
                loadSummaryData();
            });

            // Add visit modal
            $('#addVisitBtn').on('click', function() {
                loadPatientCurrentDepartment();
                $('#addVisitModal').modal('show');
            });

            // Add visit form submission
            $('#addVisitForm').on('submit', function(e) {
                e.preventDefault();
                createVisit();
            });

            // Table action buttons
            $('#visitsTable tbody').on('click', '.view-btn', function() {
                const visitId = $(this).data('id');
                viewVisit(visitId);
            });

            $('#visitsTable tbody').on('click', '.edit-btn', function() {
                const visitId = $(this).data('id');
                editVisit(visitId);
            });

            $('#visitsTable tbody').on('click', '.delete-btn', function() {
                const visitId = $(this).data('id');
                deleteVisit(visitId);
            });
        }

        function loadPatientVisits() {
            $.ajax({
                url: `/api/patient_visits/${currentPatientId}`,
                method: 'GET',
                success: function(response) {
                    console.log('Patient visits response:', response);
                    visitsData = response.visits || [];
                    updatePatientHeader(response.patient);
                    updateVisitsTable();
                    createTimeline();
                },
                error: function(xhr) {
                    console.error('Error loading patient visits:', xhr);
                    showError('Không thể tải danh sách lượt khám');
                }
            });
        }

        function loadSummaryData() {
            $.ajax({
                url: `/api/patient_visits/${currentPatientId}/summary`,
                method: 'GET',
                success: function(response) {
                    console.log('Summary response:', response);
                    summaryData = response;
                    updateStatistics();
                    updateCommonDiagnoses();
                },
                error: function(xhr) {
                    console.error('Error loading summary:', xhr);
                }
            });
        }

        function updatePatientHeader(patient) {
            if (patient) {
                $('#patientName').text(patient.PatientName || 'N/A');
                $('#patientId').text(patient.PatientId || 'N/A');
                $('#patientGender').text(patient.PatientGender || 'N/A');
                $('#patientAge').text(patient.PatientAge || 'N/A');
            }
        }

        function updateStatistics() {
            if (summaryData && summaryData.summary) {
                $('#totalVisits').text(summaryData.summary.total_visits || 0);
                $('#uniqueDepartments').text('N/A'); // No longer tracking departments
                
                // We don't have first visit in the new API, so we'll show N/A
                $('#firstVisitDate').text('N/A');

                const latestVisit = summaryData.summary.latest_visit;
                if (latestVisit && latestVisit.VisitTime) {
                    $('#latestVisitDate').text(new Date(latestVisit.VisitTime).toLocaleDateString('vi-VN'));
                } else {
                    $('#latestVisitDate').text('N/A');
                }
            }
        }

        function updateVisitsTable() {
            visitsTable.clear().rows.add(visitsData).draw();
        }

        function createTimeline() {
            const container = $('#timelineContainer');
            
            if (!visitsData || visitsData.length === 0) {
                container.html(`
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h5>Chưa có lượt khám nào</h5>
                        <p>Bệnh nhân này chưa có lịch sử khám bệnh.</p>
                        <button class="btn btn-primary" id="addFirstVisitBtn">
                            <i class="fas fa-plus me-2"></i>Thêm lượt khám đầu tiên
                        </button>
                    </div>
                `);
                $('#addFirstVisitBtn').on('click', function() {
                    $('#addVisitBtn').click();
                });
                return;
            }

            let timelineHtml = '<ul class="timeline">';
            
            visitsData.forEach((visit, index) => {
                const visitDate = visit.VisitTime ? new Date(visit.VisitTime).toLocaleDateString('vi-VN') : 'Chưa xác định';
                const visitTime = visit.VisitTime ? new Date(visit.VisitTime).toLocaleTimeString('vi-VN') : '';
                
                let diagnosesHtml = '';
                if (visit.diagnoses && visit.diagnoses.length > 0) {
                    visit.diagnoses.forEach(diag => {
                        if (diag.ActualDiagnosis) {
                            diagnosesHtml += `<span class="diagnosis-badge">${diag.ActualDiagnosis}</span>`;
                        }
                    });
                }

                const iconColor = index === 0 ? 'bg-success' : 'bg-primary';
                
                timelineHtml += `
                    <li class="timeline-item">
                        <div class="timeline-icon ${iconColor} text-white">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div class="card visit-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="card-title mb-1">
                                            <i class="fas fa-calendar me-2"></i>${visitDate}
                                            ${visitTime ? `<small class="text-muted ms-2">${visitTime}</small>` : ''}
                                        </h6>
                                        <span class="department-badge">Khoa hiện tại</span>
                                    </div>
                                    <span class="badge bg-primary visit-purpose-badge">${visit.VisitPurpose || 'N/A'}</span>
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-user-md me-2 text-muted"></i>
                                    <strong>Bác sĩ:</strong><br>
                                    ${visit.staff && visit.staff.length > 0 ? 
                                        visit.staff.map(staff => 
                                            `<span class="staff-badge">${staff.StaffName} - ${staff.StaffRole}</span>`
                                        ).join('<br>') : 
                                        '<span class="text-muted">Chưa có bác sĩ</span>'
                                    }
                                </div>
                                ${diagnosesHtml ? `
                                    <div class="mb-2">
                                        <i class="fas fa-diagnoses me-2 text-muted"></i>
                                        <strong>Chẩn đoán:</strong><br>
                                        ${diagnosesHtml}
                                    </div>
                                ` : ''}
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary me-2 view-btn" data-id="${visit.VisitId}">
                                        <i class="fas fa-eye me-1"></i>Xem chi tiết
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-2 edit-btn" data-id="${visit.VisitId}">
                                        <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            timelineHtml += '</ul>';
            container.html(timelineHtml);
        }



        function updateCommonDiagnoses() {
            const container = $('#commonDiagnoses');
            
            // Since the new API doesn't provide common diagnoses, we'll show a message
            container.html(`
                <div class="empty-state">
                    <i class="fas fa-diagnoses"></i>
                    <p>Chức năng thống kê chẩn đoán sẽ được cập nhật</p>
                </div>
            `);
        }

        function loadPatientCurrentDepartment() {
            // Since visits no longer have department, we'll load all available staff
            loadAllStaff();
        }

        function loadAllStaff() {
            $.ajax({
                url: `/api/staff`,
                method: 'GET',
                success: function(response) {
                    console.log('Staff response:', response);
                    const staff = response.staff || [];
                    let options = '<option value="">Chọn bác sĩ...</option>';
                    staff.forEach(person => {
                        options += `<option value="${person.StaffId}">${person.StaffName} - ${person.StaffRole}</option>`;
                    });
                    $('#visitStaff').html(options);
                    // Clear any previous selections
                    $('#visitStaff').val([]);
                },
                error: function(xhr) {
                    console.error('Error loading staff:', xhr);
                    showError('Không thể tải danh sách bác sĩ');
                }
            });
        }

        function createVisit() {
            // Validate form
            const staffIds = $('#visitStaff').val();
            if (!staffIds || staffIds.length === 0) {
                showError('Vui lòng chọn ít nhất một bác sĩ');
                return;
            }
            
            const visitPurpose = $('#visitPurpose').val();
            if (!visitPurpose) {
                showError('Vui lòng chọn mục đích khám');
                return;
            }

            const formData = {
                VisitPurpose: visitPurpose,
                StaffIds: staffIds,
                diagnosis: $('#visitDiagnosis').val(),
                ICDCode: $('#visitICDCode').val()
            };

            $.ajax({
                url: `/api/patient_visits/${currentPatientId}/create`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    $('#addVisitModal').modal('hide');
                    $('#addVisitForm')[0].reset();
                    showSuccess('Thêm lượt khám thành công!');
                    loadPatientVisits();
                    loadSummaryData();
                },
                error: function(xhr) {
                    console.error('Error creating visit:', xhr);
                    const error = xhr.responseJSON?.error || 'Có lỗi xảy ra khi thêm lượt khám';
                    showError(error);
                }
            });
        }

        function viewVisit(visitId) {
            // TODO: Implement view visit details
            alert('Chức năng xem chi tiết lượt khám sẽ được phát triển');
        }

        function editVisit(visitId) {
            // TODO: Implement edit visit
            alert('Chức năng chỉnh sửa lượt khám sẽ được phát triển');
        }

        function deleteVisit(visitId) {
            if (confirm('Bạn có chắc chắn muốn xóa lượt khám này?')) {
                // TODO: Implement delete visit
                alert('Chức năng xóa lượt khám sẽ được phát triển');
            }
        }

        function showSuccess(message) {
            // TODO: Implement toast notification
            alert(message);
        }

        function showError(message) {
            // TODO: Implement toast notification
            alert('Lỗi: ' + message);
        }
    </script>
</body>
</html>
